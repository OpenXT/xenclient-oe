#OpenXT:Use WPA-PSK mechanism to authenticate on a WLAN connection.
--- a/configure.ac
+++ b/configure.ac
@@ -120,6 +120,10 @@ else
     AC_DEFINE_UNQUOTED([MOBILE_BROADBAND_PROVIDER_INFO_DATABASE],["$prefix/share/mobile-broadband-provider-info/serviceproviders.xml"],[Mobile Broadband Service Provider Information Database location])
 fi
 
+dnl Add libcrypto for PKCS5_PBKDF2_HMAC_SHA1
+dnl OpenXT patch always-use-psk-hash.patch
+PKG_CHECK_MODULES(OPENSSL, libcrypto libssl,, AC_MSG_ERROR([openssl cannot be found.]))
+
 dnl
 dnl API documentation
 dnl
--- a/meson.build
+++ b/meson.build
@@ -108,6 +108,7 @@ gio_dep = dependency('gio-2.0', version: '>= 2.38')
 gmodule_export_dep = dependency('gmodule-export-2.0')
 libsecret_dep = dependency('libsecret-1', version: '>= 0.18')
 libnma_dep = dependency('libnma', version: '>= 1.8.27')
+openssl_dep = dependency('openssl', version: '>= 1.0.0')
 
 m_dep = cc.find_library('m')
 
--- a/src/wireless-security/meson.build
+++ b/src/wireless-security/meson.build
@@ -49,7 +49,8 @@ deps = [
   gtk_dep,
   libnm_dep,
   libnma_dep,
-  libutils_libnm_dep
+  libutils_libnm_dep,
+  openssl_dep
 ]
 
 libwireless_security_libnm = static_library(
--- a/src/wireless-security/ws-wpa-psk.c
+++ b/src/wireless-security/ws-wpa-psk.c
@@ -29,6 +29,7 @@
 #include "helpers.h"
 #include "nma-ui-utils.h"
 #include "utils.h"
+#include <openssl/evp.h>
 
 #define WPA_PMK_LEN 32
 
@@ -104,6 +105,17 @@ add_to_size_group (WirelessSecurity *par
 	gtk_size_group_add_widget (group, widget);
 }
 
+//adapted from stackoverflow.com/a/22795472
+static void
+PBKDF2_HMAC_SHA_1nat_string (const char* pass, const char* salt, int iterations, unsigned int outputBytes, char* hexResult)
+{
+	unsigned int i;
+	unsigned char digest[outputBytes];
+	PKCS5_PBKDF2_HMAC_SHA1 (pass, strlen (pass), (const unsigned char*) salt, strlen (salt), iterations, outputBytes, digest);
+	for (i = 0; i < sizeof (digest); i++)
+		snprintf (hexResult + (i * 2), 3, "%02x", digest[i]);
+}
+
 static void
 fill_connection (WirelessSecurity *parent, NMConnection *connection)
 {
@@ -130,6 +142,18 @@ fill_connection (WirelessSecurity *paren
 	widget = GTK_WIDGET (gtk_builder_get_object (parent->builder, "wpa_psk_entry"));
 	passwd_entry = widget;
 	key = gtk_entry_get_text (GTK_ENTRY (widget));
+
+	if (strlen (key) < 64) {
+		char keyHash[64 + 1];
+		const GByteArray *ssid = nm_setting_wireless_get_ssid (s_wireless);
+		GString *ssidNullTerminated = g_string_new_len ((const gchar *)ssid->data, ssid->len);
+
+		PBKDF2_HMAC_SHA_1nat_string (key, ssidNullTerminated->str, 4096, 32, keyHash);
+		key = keyHash;
+
+		g_string_free (ssidNullTerminated, TRUE);
+	}
+
 	g_object_set (s_wireless_sec, NM_SETTING_WIRELESS_SECURITY_PSK, key, NULL);
 
 	/* Save PSK_FLAGS to the connection */
--- a/Makefile.am
+++ b/Makefile.am
@@ -262,12 +262,14 @@ src_wireless_security_libwireless_security_libnm_la_CPPFLAGS = \
 	"-I$(srcdir)/src/utils" \
 	$(GTK3_CFLAGS) \
 	$(LIBNMA_CFLAGS) \
-	$(LIBNM_CFLAGS)
+	$(LIBNM_CFLAGS) \
+	$(OPENSSL_CFLAGS)
 
 src_wireless_security_libwireless_security_libnm_la_LIBADD = \
 	src/utils/libutils-libnm.la \
 	$(GTK3_LIBS) \
-	$(LIBNM_LIBS)
+	$(LIBNM_LIBS) \
+	$(OPENSSL_LIBS)
 
 $(src_wireless_security_libwireless_security_libnm_la_OBJECTS): $(wireless_security_h_gen)
 

