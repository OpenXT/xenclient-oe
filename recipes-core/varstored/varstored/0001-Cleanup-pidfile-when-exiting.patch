From 8794979384352010b0672b74995d3bfb8b8048ea Mon Sep 17 00:00:00 2001
From: Jason Andryuk <jandryuk@gmail.com>
Date: Mon, 6 Jun 2022 14:42:08 -0400
Subject: [PATCH] Cleanup pidfile when exiting

The pidfile is left on disk when varstored exits.  Remove it since
varstored is no longer running.

Signed-off-by: Jason Andryuk <jandryuk@gmail.com>
---
 varstored.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/varstored.c b/varstored.c
index 07ee86c..17bb9f7 100644
--- a/varstored.c
+++ b/varstored.c
@@ -559,6 +559,7 @@ int
 main(int argc, char **argv)
 {
     struct sigaction sigterm_handler;
+    char            *pidfile = NULL;
     char            *domain_str;
     char            *ptr;
     int             index;
@@ -625,7 +626,8 @@ main(int argc, char **argv)
             break;
 
         case VARSTORED_OPT_PIDFILE:
-            if (!create_pidfile(optarg))
+            pidfile = optarg;
+            if (!create_pidfile(pidfile))
                 exit(1);
             break;
 
@@ -720,5 +722,8 @@ main(int argc, char **argv)
     if (!db->save())
         return 1;
 
+    if (pidfile)
+        unlink(pidfile);
+
     return 0;
 }
-- 
2.36.1

