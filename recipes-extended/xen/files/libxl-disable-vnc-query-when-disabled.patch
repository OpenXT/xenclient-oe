################################################################################
SHORT DESCRIPTION:
################################################################################
Don't ask qemu if it supports VNC when the config file says vnc=0

################################################################################
LONG DESCRIPTION:
################################################################################
On QMP init, libxl always asks QEMU if it supports VNC, even when disabled.
When QEMU replies by the negative, xl prints an error message in the logs.
This patch adds a check to see if VNC is enabled before probing QEMU.

################################################################################
CHANGELOG
################################################################################
Authors:
Jed Lejosne <lejosnej@ainfosec.com>

################################################################################
REMOVAL
################################################################################
If upstreamed

################################################################################
UPSTREAM PLAN
################################################################################
Seems like a good candidate for upstream

################################################################################
INTERNAL DEPENDENCIES
################################################################################

################################################################################
PATCHES
################################################################################
--- a/tools/libxl/libxl_dm.c
+++ b/tools/libxl/libxl_dm.c
@@ -3318,6 +3318,8 @@ static void device_model_postconfig_char
         if (rc) goto out;
     }
 
+    if (libxl__dm_vnc(dmss->guest_config) == NULL) goto out;
+
     qmp->callback = device_model_postconfig_vnc;
     rc = libxl__ev_qmp_send(egc, qmp, "query-vnc", NULL);
     if (rc) goto out;
